#!/bin/sh
set -e

PROFILES_DIR="${HOME}/.claude/profiles"
DEFAULT_FILE="${PROFILES_DIR}/.default"

# --- Helper functions ---

die() {
    printf 'claude-profile: %s\n' "$1" >&2
    exit 1
}

usage() {
    cat <<'EOF'
Usage: claude-profile [command] [args...]

Commands:
    (no command)            Launch Claude with the default profile
    use <name> [args...]    Launch Claude with the named profile
    create <name>           Create a new profile
    list, ls                List all profiles
    default [name]          Get or set the default profile
    delete <name>           Delete a profile
    which [name]            Show the resolved config directory path
    help, -h, --help        Show this help message

When invoked with no command (or with flags like -p, --verbose, etc.),
claude-profile launches Claude using the default profile, passing all
arguments through.

Examples:
    claude-profile create work
    claude-profile default work
    claude-profile                  # launches claude with "work" profile
    claude-profile use work -p      # launches claude -p with "work" profile
    claude-profile --resume         # launches claude --resume with default profile
EOF
}

# Resolve a profile name to its full directory path.
# If an argument is given, use that as the profile name.
# Otherwise, read the default profile from the .default file.
# Prints the resolved path to stdout.
resolve_profile_dir() {
    if [ -n "${1:-}" ]; then
        _rp_name="$1"
    else
        if [ ! -f "$DEFAULT_FILE" ]; then
            die "no default profile set. Use: claude-profile default <name>"
        fi
        _rp_name=$(cat "$DEFAULT_FILE")
        if [ -z "$_rp_name" ]; then
            die "default profile file is empty. Set one with: claude-profile default <name>"
        fi
    fi
    _rp_dir="${PROFILES_DIR}/${_rp_name}"
    if [ ! -d "$_rp_dir" ]; then
        die "profile '${_rp_name}' does not exist. Create it with: claude-profile create ${_rp_name}"
    fi
    printf '%s' "$_rp_dir"
}

# --- Commands ---

cmd_create() {
    [ -z "${1:-}" ] && die "usage: claude-profile create <name>"
    _cc_dir="${PROFILES_DIR}/$1"
    if [ -d "$_cc_dir" ]; then
        die "profile '$1' already exists"
    fi
    mkdir -p "$_cc_dir"
    printf 'Created profile: %s\n' "$1"
    printf 'Config directory: %s\n' "$_cc_dir"
}

cmd_list() {
    if [ ! -d "$PROFILES_DIR" ]; then
        printf 'No profiles found. Create one with: claude-profile create <name>\n'
        return
    fi
    _cl_default=""
    if [ -f "$DEFAULT_FILE" ]; then
        _cl_default=$(cat "$DEFAULT_FILE")
    fi
    _cl_found=0
    for _cl_entry in "$PROFILES_DIR"/*/; do
        [ -d "$_cl_entry" ] || continue
        _cl_name=$(basename "$_cl_entry")
        _cl_found=1
        if [ "$_cl_name" = "$_cl_default" ]; then
            printf '* %s (default)\n' "$_cl_name"
        else
            printf '  %s\n' "$_cl_name"
        fi
    done
    if [ "$_cl_found" -eq 0 ]; then
        printf 'No profiles found. Create one with: claude-profile create <name>\n'
    fi
}

cmd_default() {
    if [ -z "${1:-}" ]; then
        # Show current default
        if [ -f "$DEFAULT_FILE" ]; then
            cat "$DEFAULT_FILE"
            printf '\n'
        else
            die "no default profile set. Set one with: claude-profile default <name>"
        fi
        return
    fi
    _cd_dir="${PROFILES_DIR}/$1"
    if [ ! -d "$_cd_dir" ]; then
        die "profile '$1' does not exist. Create it with: claude-profile create $1"
    fi
    mkdir -p "$PROFILES_DIR"
    printf '%s' "$1" > "$DEFAULT_FILE"
    printf 'Default profile set to: %s\n' "$1"
}

cmd_which() {
    _cw_dir=$(resolve_profile_dir "${1:-}")
    printf '%s\n' "$_cw_dir"
}

cmd_use() {
    [ -z "${1:-}" ] && die "usage: claude-profile use <name> [claude args...]"
    _cu_name="$1"
    shift
    _cu_dir="${PROFILES_DIR}/${_cu_name}"
    if [ ! -d "$_cu_dir" ]; then
        die "profile '${_cu_name}' does not exist. Create it with: claude-profile create ${_cu_name}"
    fi
    export CLAUDE_CONFIG_DIR="$_cu_dir"
    exec claude "$@"
}

cmd_delete() {
    [ -z "${1:-}" ] && die "usage: claude-profile delete <name>"
    _cdel_name="$1"
    _cdel_dir="${PROFILES_DIR}/${_cdel_name}"
    if [ ! -d "$_cdel_dir" ]; then
        die "profile '${_cdel_name}' does not exist"
    fi
    printf 'Delete profile "%s" and all its data? [y/N] ' "$_cdel_name"
    read -r _cdel_confirm
    case "$_cdel_confirm" in
        [yY]|[yY][eE][sS])
            rm -rf "$_cdel_dir"
            printf 'Deleted profile: %s\n' "$_cdel_name"
            # Clear default if it was this profile
            if [ -f "$DEFAULT_FILE" ]; then
                _cdel_current=$(cat "$DEFAULT_FILE")
                if [ "$_cdel_current" = "$_cdel_name" ]; then
                    rm -f "$DEFAULT_FILE"
                    printf 'Cleared default profile (was "%s")\n' "$_cdel_name"
                fi
            fi
            ;;
        *)
            printf 'Cancelled.\n'
            ;;
    esac
}

cmd_launch_default() {
    _cld_dir=$(resolve_profile_dir)
    export CLAUDE_CONFIG_DIR="$_cld_dir"
    exec claude "$@"
}

# --- Dispatcher ---

main() {
    case "${1:-}" in
        "")             cmd_launch_default ;;
        create)         shift; cmd_create "$@" ;;
        list|ls)        shift; cmd_list ;;
        default)        shift; cmd_default "$@" ;;
        which)          shift; cmd_which "$@" ;;
        use)            shift; cmd_use "$@" ;;
        delete)         shift; cmd_delete "$@" ;;
        help|-h|--help) usage ;;
        -*)             cmd_launch_default "$@" ;;
        *)              die "unknown command '$1'. Run 'claude-profile help' for usage." ;;
    esac
}

main "$@"
